<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>KodacView</title>
  <link rel="icon" href="seu_icone_aqui.png" />
  <style>
    /* Seu estilo anterior permanece, mantenha o CSS conforme o último funcionando */
  </style>
</head>
<body>
  <h1>KodacView</h1>

  <div class="controls" id="auth">
    <input type="text" id="username" placeholder="Nome de usuário" />
    <input type="password" id="password" placeholder="Senha" />
    <button onclick="signUp()">Cadastrar</button>
    <button onclick="signIn()">Entrar</button>
  </div>

  <div class="controls" id="uploadSection" style="display:none;">
    <span id="welcome"></span>
    <input type="file" id="fileInput" accept="image/*">
    <input type="text" id="descInput" placeholder="Descrição da imagem">
    <button onclick="uploadImage()">Enviar</button>
    <button onclick="logout()">Sair</button>
  </div>

  <div id="gallery"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://qewcnffjcrtqwutjymfd.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFld2NuZmZqY3J0cXd1dGp5bWZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM5NzI2NzYsImV4cCI6MjA1OTU0ODY3Nn0.XBlNVZ8qmb8ZyMmO9YIWidDJUhdI9b_KBT6YRuVYUq8';
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;

    async function signUp() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!username || !password) return alert('Preencha todos os campos.');

      const hash = await sha256(password);

      const { data, error } = await supabase
        .from('profiles')
        .insert([{ username, senha_hash: hash }]);

      if (error) {
        alert('Erro no cadastro: ' + error.message);
      } else {
        alert('Cadastro realizado com sucesso. Agora entre.');
      }
    }

    async function signIn() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const hash = await sha256(password);

      const { data, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('username', username)
        .eq('senha_hash', hash)
        .single();

      if (error || !data) {
        alert('Usuário ou senha inválidos');
      } else {
        currentUser = data;
        document.getElementById('auth').style.display = 'none';
        document.getElementById('uploadSection').style.display = 'block';
        document.getElementById('welcome').textContent = `Bem-vindo, ${currentUser.username}`;
        loadGallery();
      }
    }

    async function uploadImage() {
      const file = document.getElementById('fileInput').files[0];
      const description = document.getElementById('descInput').value;

      if (!file || !currentUser) return;

      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', 'polaroid');

      const res = await fetch('https://api.cloudinary.com/v1_1/dbfwu9sdz/image/upload', {
        method: 'POST',
        body: formData,
      });

      const data = await res.json();
      const imageUrl = data.secure_url;

      await supabase.from('fotos').insert([
        { url: imageUrl, descricao: description, username: currentUser.username }
      ]);

      loadGallery();
      document.getElementById('fileInput').value = '';
      document.getElementById('descInput').value = '';
    }

    async function deleteImage(id, username) {
      if (currentUser?.username !== username) {
        alert('Você só pode excluir suas próprias fotos.');
        return;
      }

      const confirmDelete = confirm('Deseja excluir esta imagem?');
      if (confirmDelete) {
        await supabase.from('fotos').delete().eq('id', id);
        loadGallery();
      }
    }

    async function loadGallery() {
      const { data, error } = await supabase
        .from('fotos')
        .select('*')
        .order('id', { ascending: false });

      const gallery = document.getElementById('gallery');
      gallery.innerHTML = "";

      data.forEach(foto => {
        const div = document.createElement('div');
        div.className = 'polaroid';
        div.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 5px;">@${foto.username}</div>
          <img src="${foto.url}" alt="Foto">
          <div class="description">${foto.descricao}</div>
          ${currentUser?.username === foto.username
            ? `<button class="delete-btn" onclick="deleteImage(${foto.id}, '${foto.username}')">X</button>`
            : ''
          }
        `;
        gallery.appendChild(div);
      });
    }

    function logout() {
      currentUser = null;
      document.getElementById('auth').style.display = 'block';
      document.getElementById('uploadSection').style.display = 'none';
      document.getElementById('gallery').innerHTML = '';
    }

    async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }
  </script>
</body>
</html>
